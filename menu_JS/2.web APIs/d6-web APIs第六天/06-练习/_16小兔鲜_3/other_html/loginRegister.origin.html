<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>小兔鲜儿 - 新鲜 惠民 快捷!</title>
  <link rel="icon" href="./favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="./iconfont/iconfont.css">
  <link rel="stylesheet" href="https://at.alicdn.com/t/font_2143783_iq6z4ey5vu.css">
  <link rel="stylesheet" href="./css/base.css">
  <link rel="stylesheet" href="./css/common.css">
  <link rel="stylesheet" href="./css/loginRegister.css">
</head>
<body>
  <header class="w header">
    <div class="logo">
      <h1><a href="index.html" title="小兔鲜儿">小兔鲜儿</a></h1>
    </div>
    <a class="home" href="./index.html">进入网站首页</a>
  </header>
  <main>
    <div class="main">
      <div class="w">
        <form action="" autocomplete="off">
          <!-- 登录模块 -->
          <div class="box login">
            <div class="tab-nav">
              <a href="javascript:;" data-id="0" class="active">账户登录</a>
              <a href="javascript:;" data-id="1">二维码登录</a>
            </div>
            <div class="tab-pane" data-id="0">
              <div class="input">
                <span class="iconfont icon-arrow-right-bold"></span>
                <input required type="text" placeholder="请输入用户名称/手机号码" name="username">
              </div>
              <div class="input">
                <span class="iconfont icon-arrow-right-bold"></span>
                <input required type="password" placeholder="请输入密码" name="password">
              </div>
              <div class="link">
                <a href="javascript:;">手机验证码登录</a>
              </div>
              <div class="agree">
                <label for="my-checkbox">
                  <input type="checkbox" value="1" id="my-checkbox" class="remember" name="agree">
                  <span class="iconfont icon-xuanze"></span>
                </label>
                我已同意 <a href="javascript:;">《服务条款》</a>
              </div>
              <div class="button">
                <button type="submit" class="btnSubmit">登 录</button>
                <div class="else-btnSubmit">
                  <a href="./forget.html">忘记密码？</a>
                  <a class="toRegister" href="javascript:;">免费注册</a>
                </div>
              </div>
            </div>
            <div class="tab-pane" data-id="1" style="display: none;">
              <img class="qr-code" src="./images/code.png" alt="">
            </div>
          </div>
          <!-- 注册模块 -->
          <div class="box register" hidden>
            <h3>新用户注册</h3>
            <div class="tab-pane">
              <div class="input">
                <span class="iconfont icon-zhanghao"></span>
                <input name="username" type="text" placeholder="设置用户名称">
                <span class="msg"></span>
              </div>
              <div class="input">
                <span class="iconfont icon-shouji"></span>
                <input name="phone" type="text" placeholder="输入手机号码  ">
                <span class="msg"></span>
              </div>
              <div class="input">
                <span class="iconfont icon-zhibiaozhushibiaozhu"></span>
                <input name="code" type="text" placeholder="短信验证码">
                <span class="msg"></span>
                <a class="send-code" href="javascript:;">发送验证码</a>
              </div>
              <div class="input">
                <span class="iconfont icon-suo"></span>
                <input name="password" type="password" placeholder="设置6至20位字母、数字和符号组合">
                <span class="msg"></span>
              </div>
              <div class="input">
                <span class="iconfont icon-suo"></span>
                <input name="confirm" type="password" placeholder="请再次输入上面密码">
                <span class="msg"></span>
              </div>
              <div class="agree">
                <i class="iconfont icon-queren"></i>
                已阅读并同意<i>《用户服务协议》</i>
              </div>
              <div class="button">
                <button type="submit" class="btnSubmit">注 册</button>
              </div>
              <div class="else-btnSubmit">
                <a class="toLogin" href="javascript:;">已有账户，去登录</a>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </main>
  <footer class="footer">
    <div class="w">
      <div class="copyright">
        <p>
          <a href="#">关于我们</a> |
          <a href="#">联系我们</a> |
          <a href="#">配送与验收</a> |
          <a href="#">商务合作</a> |
          <a href="#">搜索推荐</a> |
          <a href="#">友情链接</a>
        </p>
        <p>CopyRight © &copy; 小兔鲜</p>
      </div>
    </div>
  </footer>

  <!-- 优化第二版 -->
  <!-- orgin是原来的，我把refactor-版替换到原始文件了 -->
  <script>

    // 因为login、register模块中有相同名称变量，所以我暂时使用function保住各自模块
    // login模块
    (function () {
      // 1.--- tab栏切换  事件委托（仅作用于登录模块，避免影响注册模块的 tab-pane）
      const loginBox = document.querySelector('.login')
      const tabNav = loginBox.querySelector('.tab-nav')
      const loginPanes = loginBox.querySelectorAll('.tab-pane')
      // 2.--- 切换登录/注册逻辑 （统一入口，避免重复代码）
      const registerBox = document.querySelector('.register')
      const toRegisterBtn = document.querySelector('.toRegister')
      const toLoginBtn = document.querySelector('.toLogin')
      // 3.--- 登录表单提交（仅示例：记录本地并跳转），作用于登录模块的输入 name 带前缀
      const loginForm = document.querySelector('form')
      const loginAgree = document.querySelector('[name=agree]')
      const loginUsername = document.querySelector('[name=login-username]')

      // 1.--- 
      // 封装 showLoginPane 函数，用来显示对应的登录面板
      function showLoginPane(index) {
        loginPanes.forEach((p, i) => {
          p.style.display = i === index ? 'block' : 'none'
        })
      }

      // 事件监听
      tabNav.addEventListener('click', function (e) {
        if (e.target.tagName === 'A') {
          tabNav.querySelector('.active').classList.remove('active')
          e.target.classList.add('active')
          showLoginPane(Number(e.target.dataset.id))
          // 先干掉所有人  for循环  // 让对应序号的 大pane 显示 =》showLoginPane
          // for (let i = 0; i < loginPanes.length; i++) {
          //   loginPanes[i].style.display = 'none'
          // }
          // loginPanes[e.target.dataset.id].style.display = 'block'
        }
      })

      // 2.---
      // 合并后，添加的切换登录、注册有关逻辑
      function toggleLR(e) {
        if (e && e.preventDefault) e.preventDefault()
        // 切换登录/注册面板的可见性
        // 使用 hidden 属性保证与初始 HTML 保持一致
        if (loginBox && registerBox) {
          loginBox.hidden = !loginBox.hidden
          registerBox.hidden = !registerBox.hidden
        }
      }

      if (toLogin) toLogin.addEventListener('click', toggleLR)
      if (toRegister) toRegister.addEventListener('click', toggleLR)

      // 3.---
      // 点击提交模块
      loginForm.addEventListener('submit', function (e) {
        // 如果当前显示的是注册模块，让注册模块处理提交（注册模块内部会阻止提交）
        if (!loginBox.hidden) {
          e.preventDefault()
          if (!loginAgree.checked) return alert('请勾选同意协议')
          localStorage.setItem('uname', loginUsername.value || '')
          location.href = './index.html'
        }
      })

    })();


    // register模块
    (function () {
      // 发送短信验证码模块（限定到注册模块的验证码按钮，避免与登录模块的 QR image 冲突）
      /* 注册模块相关逻辑：验证码、验证、提交等，作用域限定在 .register 下 */
      const registerBox = document.querySelector('.register')
      const sendCodeBtn = registerBox ? registerBox.querySelector('.send-code') : null

        // 发送验证码：防重复点击、倒计时（基于注册模块的按钮）
        (function () {
          if (!sendCodeBtn) return
          let timerId = null
          sendCodeBtn.addEventListener('click', function (e) {
            e.preventDefault()
            if (timerId) return
            let i = 5
            sendCodeBtn.textContent = `0${i}秒后重新获取`
            timerId = setInterval(function () {
              i--
              sendCodeBtn.textContent = `0${i}秒后重新获取`
              if (i === 0) {
                clearInterval(timerId)
                timerId = null
                sendCodeBtn.textContent = '重新获取'
              }
            }, 1000)
          })
        })();

      // 注册表单字段验证（选择器限定到 .register 内）
      const regUsername = registerBox.querySelector('[name=username]')
      const regPhone = registerBox.querySelector('[name=phone]')
      const regCode = registerBox.querySelector('[name=code]')
      const regPassword = registerBox.querySelector('[name=password]')
      const regConfirm = registerBox.querySelector('[name=confirm]')

      function setMsg(el, text) {
        if (!el) return
        const span = el.nextElementSibling
        if (span) span.innerText = text
      }

      function verifyName() {
        const reg = /^[a-zA-Z0-9-_]{6,10}$/
        if (!reg.test(regUsername.value)) {
          setMsg(regUsername, '输入不合法,请输入6~10位')
          return false
        }
        setMsg(regUsername, '')
        return true
      }

      function verifyPhone() {
        const reg = /^1(3\d|4[5-9]|5[0-35-9]|6[567]|7[0-8]|8\d|9[0-35-9])\d{8}$/
        if (!reg.test(regPhone.value)) {
          setMsg(regPhone, '输入不合法,请输入正确的11位手机号码')
          return false
        }
        setMsg(regPhone, '')
        return true
      }

      function verifyCode() {
        const reg = /^\d{6}$/
        if (!reg.test(regCode.value)) {
          setMsg(regCode, '输入不合法,6 位数字')
          return false
        }
        setMsg(regCode, '')
        return true
      }

      function verifyPwd() {
        const reg = /^[a-zA-Z0-9-_]{6,20}$/
        if (!reg.test(regPassword.value)) {
          setMsg(regPassword, '输入不合法,6~20位数字字母符号组成')
          return false
        }
        setMsg(regPassword, '')
        return true
      }

      function verifyConfirm() {
        if (regConfirm.value !== regPassword.value) {
          setMsg(regConfirm, '两次密码输入不一致')
          return false
        }
        setMsg(regConfirm, '')
        return true
      }

      function bindVerify() {
        if (regUsername) regUsername.addEventListener('change', verifyName)
        if (regPhone) regPhone.addEventListener('change', verifyPhone)
        if (regCode) regCode.addEventListener('change', verifyCode)
        if (regPassword) regPassword.addEventListener('change', verifyPwd)
        if (regConfirm) regConfirm.addEventListener('change', verifyConfirm)
      }

      bindVerify()

      // 我已同意 切换样式
      const queren = registerBox ? registerBox.querySelector('.icon-queren') : null
      if (queren) queren.addEventListener('click', function () { this.classList.toggle('icon-queren2') })

      // 注册提交（限定在 register 模块）
      const regForm = document.querySelector('form')
      regForm.addEventListener('submit', function (e) {
        if (!registerBox.hidden) {
          // 当显示的是注册模块，注册模块负责拦截与校验
          if (queren && !queren.classList.contains('icon-queren2')) {
            alert('请勾选同意协议')
            e.preventDefault()
            return
          }

          if (!verifyName()) e.preventDefault()
          if (!verifyPhone()) e.preventDefault()
          if (!verifyCode()) e.preventDefault()
          if (!verifyPwd()) e.preventDefault()
          if (!verifyConfirm()) e.preventDefault()
        }
      })

    })();
  </script>
</body>
</html>
