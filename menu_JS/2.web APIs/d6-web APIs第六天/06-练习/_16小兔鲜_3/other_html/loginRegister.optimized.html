<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>小兔鲜儿 - 登录 / 注册（优化版）</title>
  <link rel="icon" href="./favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="./iconfont/iconfont.css">
  <link rel="stylesheet" href="https://at.alicdn.com/t/font_2143783_iq6z4ey5vu.css">
  <link rel="stylesheet" href="./css/base.css">
  <link rel="stylesheet" href="./css/common.css">
  <link rel="stylesheet" href="./css/loginRegister.optimized.css">
</head>

<body>
  <header class="w header">
    <div class="logo">
      <h1><a href="index.html" title="小兔鲜儿">小兔鲜儿</a></h1>
    </div>
    <a class="home" href="./index.html">进入网站首页</a>
  </header>

  <main>
    <div class="main">
      <div class="w">
        <form action="" autocomplete="off">

          <!-- 登录模块（两种登录方式：账户 / 二维码） -->
          <div class="box login" aria-label="登录模块">
            <div class="tab-nav" role="tablist">
              <a href="javascript:;" data-id="0" class="active">账户登录</a>
              <a href="javascript:;" data-id="1">二维码登录</a>
            </div>

            <!-- 注意：把登录内的 pane 单独命名为 .tab-pane-login，避免与注册模块的 .tab-pane 冲突 -->
            <div class="tab-pane-login" data-id="0">
              <div class="input">
                <span class="iconfont icon-arrow-right-bold"></span>
                <input required type="text" placeholder="请输入用户名称/手机号码" name="login-username">
              </div>
              <div class="input">
                <span class="iconfont icon-arrow-right-bold"></span>
                <input required type="password" placeholder="请输入密码" name="login-password">
              </div>
              <div class="link">
                <a href="javascript:;">手机验证码登录</a>
              </div>
              <div class="agree">
                <label for="my-checkbox">
                  <input type="checkbox" value="1" id="my-checkbox" class="remember" name="agree">
                  <span class="iconfont icon-xuanze"></span>
                </label>
                我已同意 <a href="javascript:;">《服务条款》</a>
              </div>
              <div class="button">
                <button type="submit" class="btnSubmit">登 录</button>
                <div class="else-btnSubmit">
                  <a href="./forget.html">忘记密码？</a>
                  <a class="toRegister" href="javascript:;">免费注册</a>
                </div>
              </div>
            </div>

            <div class="tab-pane-login" data-id="1" style="display:none;">
              <!-- 将二维码图片单独命名为 .qr-code 以避免与注册模块的 .code 冲突 -->
              <img class="qr-code" src="./images/code.png" alt="二维码登录">
            </div>
          </div>

          <!-- 注册模块（保留为独立 .register） -->
          <div class="box register" hidden aria-label="注册模块">
            <h3>新用户注册</h3>
            <div class="tab-pane">
              <div class="input">
                <span class="iconfont icon-zhanghao"></span>
                <input name="username" type="text" placeholder="设置用户名称">
                <span class="msg"></span>
              </div>
              <div class="input">
                <span class="iconfont icon-shouji"></span>
                <input name="phone" type="text" placeholder="输入手机号码">
                <span class="msg"></span>
              </div>

              <!-- 注册里的验证码按钮命名为 .send-code，与登录的 QR 区分开 -->
              <div class="input">
                <span class="iconfont icon-zhibiaozhushibiaozhu"></span>
                <input name="code" type="text" placeholder="短信验证码">
                <span class="msg"></span>
                <a class="send-code" href="javascript:;">发送验证码</a>
              </div>

              <div class="input">
                <span class="iconfont icon-suo"></span>
                <input name="password" type="password" placeholder="设置6至20位字母、数字和符号组合">
                <span class="msg"></span>
              </div>
              <div class="input">
                <span class="iconfont icon-suo"></span>
                <input name="confirm" type="password" placeholder="请再次输入上面密码">
                <span class="msg"></span>
              </div>

              <div class="agree">
                <i class="iconfont icon-queren"></i>
                已阅读并同意<i>《用户服务协议》</i>
              </div>
              <div class="button">
                <button type="submit" class="btnSubmit">注 册</button>
              </div>
              <div class="else-btnSubmit">
                <a class="toLogin" href="javascript:;">已有账户，去登录</a>
              </div>
            </div>
          </div>

        </form>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="w">
      <div class="copyright">
        <p>
          <a href="#">关于我们</a> |
          <a href="#">联系我们</a> |
          <a href="#">配送与验收</a> |
          <a href="#">商务合作</a> |
          <a href="#">搜索推荐</a> |
          <a href="#">友情链接</a>
        </p>
        <p>CopyRight © &copy; 小兔鲜</p>
      </div>
    </div>
  </footer>

  <!-- 优化第一版 -->
  <script>
    /*
      优化说明（关键点）：
        1) 避免同名类冲突：登录的二维码使用 `.qr-code`，注册的发送验证码使用 `.send-code`。
        2) 登录模块内的 tab-pane 使用 `.tab-pane-login`，防止在切换登录子面板时误影响注册模块。
        3) 所有交互均在 IIFE 内部作用域中进行，变量命名带有模块前缀，降低全局冲突风险。
        4) 切换注册/登录使用 `hidden` 属性切换整体可见性，并在切换时确保登录面板状态恢复（展示第一个 tab）。
    */

    (function () {
      // --- 登录模块：tab 切换（作用域限定在 .login）
      const loginBox = document.querySelector('.login')
      const tabNav = loginBox.querySelector('.tab-nav')
      const loginPanes = loginBox.querySelectorAll('.tab-pane-login')

      function showLoginPane(index) {
        loginPanes.forEach((p, i) => {
          p.style.display = i === index ? 'block' : 'none'
        })
      }

      tabNav.addEventListener('click', function (e) {
        if (e.target.tagName !== 'A') return
        // 切换 active
        tabNav.querySelector('.active').classList.remove('active')
        e.target.classList.add('active')
        showLoginPane(Number(e.target.dataset.id) || 0)
      })

      // --- 切换登录/注册逻辑 （统一入口，避免重复代码）
      const registerBox = document.querySelector('.register')
      const toRegisterBtn = document.querySelector('.toRegister')
      const toLoginBtn = document.querySelector('.toLogin')

      function showRegister() {
        // 隐藏登录，显示注册
        loginBox.hidden = true
        registerBox.hidden = false
        // 当显示注册时，重置登录tab为第0项（账户登录）以避免后续回切逻辑混乱
        const firstTab = tabNav.querySelector('[data-id="0"]')
        if (firstTab) {
          tabNav.querySelector('.active').classList.remove('active')
          firstTab.classList.add('active')
          showLoginPane(0)
        }
      }

      function showLogin() {
        registerBox.hidden = true
        loginBox.hidden = false
        // 确保登录模块显示第一个 pane（账户登录）
        showLoginPane(0)
      }

      if (toRegisterBtn) toRegisterBtn.addEventListener('click', function (e) { e.preventDefault(); showRegister() })
      if (toLoginBtn) toLoginBtn.addEventListener('click', function (e) { e.preventDefault(); showLogin() })

      // --- 登录表单提交（仅示例：记录本地并跳转），作用于登录模块的输入 name 带前缀
      const loginForm = document.querySelector('form')
      const loginAgree = document.querySelector('[name=agree]')
      const loginUsername = document.querySelector('[name=login-username]')

      loginForm.addEventListener('submit', function (e) {
        // 如果当前显示的是注册模块，让注册模块处理提交（注册模块内部会阻止提交）
        if (!loginBox.hidden) {
          e.preventDefault()
          if (!loginAgree.checked) return alert('请勾选同意协议')
          localStorage.setItem('uname', loginUsername.value || '')
          location.href = './index.html'
        }
      })

    })();

    (function () {
      /* 注册模块相关逻辑：验证码、验证、提交等，作用域限定在 .register 下 */
      const registerBox = document.querySelector('.register')
      const sendCodeBtn = registerBox ? registerBox.querySelector('.send-code') : null

        // 发送验证码：防重复点击、倒计时（基于注册模块的按钮）
        (function () {
          if (!sendCodeBtn) return
          let timerId = null
          sendCodeBtn.addEventListener('click', function (e) {
            e.preventDefault()
            if (timerId) return
            let i = 5
            sendCodeBtn.textContent = `0${i}秒后重新获取`
            timerId = setInterval(function () {
              i--
              sendCodeBtn.textContent = `0${i}秒后重新获取`
              if (i === 0) {
                clearInterval(timerId)
                timerId = null
                sendCodeBtn.textContent = '重新获取'
              }
            }, 1000)
          })
        })();

      // 注册表单字段验证（选择器限定到 .register 内）
      const regUsername = document.querySelector('.register [name=username]')
      const regPhone = document.querySelector('.register [name=phone]')
      const regCode = document.querySelector('.register [name=code]')
      const regPassword = document.querySelector('.register [name=password]')
      const regConfirm = document.querySelector('.register [name=confirm]')

      function setMsg(el, text) {
        if (!el) return
        const span = el.nextElementSibling
        if (span) span.innerText = text
      }

      function verifyName() {
        const reg = /^[a-zA-Z0-9-_]{6,10}$/
        if (!reg.test(regUsername.value)) {
          setMsg(regUsername, '输入不合法,请输入6~10位')
          return false
        }
        setMsg(regUsername, '')
        return true
      }

      function verifyPhone() {
        const reg = /^1(3\d|4[5-9]|5[0-35-9]|6[567]|7[0-8]|8\d|9[0-35-9])\d{8}$/
        if (!reg.test(regPhone.value)) {
          setMsg(regPhone, '输入不合法,请输入正确的11位手机号码')
          return false
        }
        setMsg(regPhone, '')
        return true
      }

      function verifyCode() {
        const reg = /^\d{6}$/
        if (!reg.test(regCode.value)) {
          setMsg(regCode, '输入不合法,6 位数字')
          return false
        }
        setMsg(regCode, '')
        return true
      }

      function verifyPwd() {
        const reg = /^[a-zA-Z0-9-_]{6,20}$/
        if (!reg.test(regPassword.value)) {
          setMsg(regPassword, '输入不合法,6~20位数字字母符号组成')
          return false
        }
        setMsg(regPassword, '')
        return true
      }

      function verifyConfirm() {
        if (regConfirm.value !== regPassword.value) {
          setMsg(regConfirm, '两次密码输入不一致')
          return false
        }
        setMsg(regConfirm, '')
        return true
      }

      if (regUsername) regUsername.addEventListener('change', verifyName)
      if (regPhone) regPhone.addEventListener('change', verifyPhone)
      if (regCode) regCode.addEventListener('change', verifyCode)
      if (regPassword) regPassword.addEventListener('change', verifyPwd)
      if (regConfirm) regConfirm.addEventListener('change', verifyConfirm)

      // 我已同意 切换样式
      const queren = registerBox ? registerBox.querySelector('.icon-queren') : null
      if (queren) queren.addEventListener('click', function () { this.classList.toggle('icon-queren2') })

      // 注册提交（限定在 register 模块）
      const regForm = document.querySelector('form')
      regForm.addEventListener('submit', function (e) {
        if (!registerBox.hidden) {
          // 当显示的是注册模块，注册模块负责拦截与校验
          if (queren && !queren.classList.contains('icon-queren2')) {
            alert('请勾选同意协议')
            e.preventDefault()
            return
          }

          if (!verifyName()) e.preventDefault()
          if (!verifyPhone()) e.preventDefault()
          if (!verifyCode()) e.preventDefault()
          if (!verifyPwd()) e.preventDefault()
          if (!verifyConfirm()) e.preventDefault()
        }
      })

    })();

  </script>
</body>

</html>