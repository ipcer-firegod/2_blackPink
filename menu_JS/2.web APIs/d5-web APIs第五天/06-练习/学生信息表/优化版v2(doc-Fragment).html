<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>学生信息管理</title>
  <link rel="stylesheet" href="css/index.css" />
</head>

<body>
  <h1>新增学员</h1>
  <form class="info" autocomplete="off">
    姓名：<input type="text" class="uname" name="uname" />
    年龄：<input type="text" class="age" name="age" />
    性别:
    <select name="gender" class="gender">
      <option value="男">男</option>
      <option value="女">女</option>
    </select>
    薪资：<input type="text" class="salary" name="salary" />
    就业城市：<select name="city" class="city">
      <option value="北京">北京</option>
      <option value="上海">上海</option>
      <option value="广州">广州</option>
      <option value="深圳">深圳</option>
      <option value="曹县">曹县</option>
    </select>
    <button type="submit" class="add">录入</button>
    <button type="button" class="update" disabled>更新</button>
    <button type="button" class="cancel" style="display:none">取消</button>
  </form>

  <h1>就业榜</h1>
  <table>
    <thead>
      <tr>
        <th>学号</th>
        <th>姓名</th>
        <th>年龄</th>
        <th>性别</th>
        <th>薪资</th>
        <th>就业城市</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <!-- 
        <tr>
          <td>1001</td>
          <td>欧阳霸天</td>
          <td>19</td>
          <td>男</td>
          <td>15000</td>
          <td>上海</td>
          <td>
            <a href="javascript:">删除</a>
          </td>
        </tr> 
        -->
    </tbody>
  </table>
  <script>
    //<!--! 相比于v1，多了 DocumentFragment 优化
    (function () {
      // 一：缓存 DOM 引用（更清晰并减少重复查询）
      const STORAGE_KEY = 'student-data'
      const info = document.querySelector('.info')
      const items = info.querySelectorAll('[name]')
      const tbody = document.querySelector('tbody')
      const addBtn = info.querySelector('.add')
      const updateBtn = info.querySelector('.update')
      const cancelBtn = info.querySelector('.cancel')
      let editingId = null // 当前编辑的 stuId

      // 二：数据读写（封装）
      function getData() {
        const raw = localStorage.getItem(STORAGE_KEY)
        return raw ? JSON.parse(raw) : []
      }
      function saveData(arr) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(arr))
      }

      // 三：渲染函数（只负责 DOM 更新）
      function render() {
        const arr = getData()
        if (!tbody) return
        // 使用 DocumentFragment 优化大量数据渲染
        tbody.innerHTML = ''
        const frag = document.createDocumentFragment()
        arr.forEach((stu, idx) => {
          const tr = document.createElement('tr')
          const tdId = document.createElement('td')
          tdId.textContent = stu.stuId
          const tdName = document.createElement('td')
          tdName.textContent = stu.uname || ''
          const tdAge = document.createElement('td')
          tdAge.textContent = stu.age || ''
          const tdGender = document.createElement('td')
          tdGender.textContent = stu.gender || ''
          const tdSalary = document.createElement('td')
          tdSalary.textContent = stu.salary || ''
          const tdCity = document.createElement('td')
          tdCity.textContent = stu.city || ''
          const tdAct = document.createElement('td')
          // 编辑与删除按钮使用 data-idx 和 data-action
          const editA = document.createElement('a')
          editA.href = 'javascript:'
          editA.textContent = '编辑'
          editA.dataset.idx = idx
          editA.dataset.action = 'edit'
          editA.style.marginRight = '8px'
          const delA = document.createElement('a')
          delA.href = 'javascript:'
          delA.textContent = '删除'
          delA.dataset.idx = idx
          delA.dataset.action = 'del'
          tdAct.appendChild(editA)
          tdAct.appendChild(delA)

          tr.appendChild(tdId)
          tr.appendChild(tdName)
          tr.appendChild(tdAge)
          tr.appendChild(tdGender)
          tr.appendChild(tdSalary)
          tr.appendChild(tdCity)
          tr.appendChild(tdAct)
          frag.appendChild(tr)
        })
        tbody.appendChild(frag)
      }

      // 辅助：防 XSS 输出
      function escapeHtml(str) {
        if (str == null) return ''
        return String(str).replace(/[&<>"']/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[s])
      }

      // 验证：返回 {ok: boolean, first: element|null}
      function validateForm() {
        for (let i = 0; i < items.length; i++) {
          const it = items[i]
          if (it.value.trim() === '') return { ok: false, first: it }
        }
        return { ok: true }
      }

      // 从表单构建对象（假定已通过验证）
      // 生成唯一 ID（基于时间戳 + 随机）
      function genId() {
        return 's_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 9)
      }

      // 从表单构建对象（假定已通过验证）
      // 如果 editingId 非空，则保持原 stuId
      function buildObj() {
        const arr = getData()
        const obj = {}
        obj.stuId = editingId ? editingId : genId()
        items.forEach(it => { obj[it.name] = it.value.trim() })
        return obj
      }

      function clearForm(form) {
        form.reset()
        // 可选：把焦点放回第一个字段
        items[0] && items[0].focus()
      }

      // 事件处理：提交
      function onSubmit(e) {
        e.preventDefault()
        const v = validateForm()
        if (!v.ok) {
          alert('输入内容不能为空')
          v.first && v.first.focus()
          return
        }
        const arr = getData()
        const obj = buildObj()
        arr.push(obj)
        saveData(arr)
        render()
        clearForm(e.target)
      }

      // 事件处理：表格内操作（删除 / 编辑）
      function onTbodyClick(e) {
        const btn = e.target.closest('[data-idx]')
        if (!btn) return
        const idx = Number(btn.dataset.idx)
        if (Number.isNaN(idx)) return
        const arr = getData()
        // 判断操作类型（使用 data-action）
        const action = btn.dataset.action
        if (action === 'del') {
          arr.splice(idx, 1)
          saveData(arr)
          render()
          // 如果当前正在编辑的记录被删除，取消编辑状态
          if (editingId && !arr.find(a => a.stuId === editingId)) {
            cancelEdit()
          }
        } else if (action === 'edit') {
          // 加载数据到表单，进入编辑模式
          const item = arr[idx]
          if (!item) return
          editingId = item.stuId
          items.forEach(it => { it.value = item[it.name] || '' })
          updateBtn.disabled = false
          addBtn.disabled = true
          cancelBtn.style.display = ''
        }
      }

      function cancelEdit() {
        editingId = null
        clearForm(info)
        updateBtn.disabled = true
        addBtn.disabled = false
        cancelBtn.style.display = 'none'
      }

      // 更新操作（当处于编辑模式时）
      function onUpdate() {
        const v = validateForm()
        if (!v.ok) {
          alert('输入内容不能为空')
          v.first && v.first.focus()
          return
        }
        const arr = getData()
        const idx = arr.findIndex(a => a.stuId === editingId)
        if (idx === -1) {
          alert('要更新的记录未找到')
          cancelEdit()
          return
        }
        const newObj = buildObj()
        arr[idx] = newObj
        saveData(arr)
        render()
        cancelEdit()
      }

      // 绑定事件
      function bind() {
        info.addEventListener('submit', onSubmit)
        tbody.addEventListener('click', onTbodyClick)
        updateBtn.addEventListener('click', onUpdate)
        cancelBtn.addEventListener('click', cancelEdit)
      }

      // 初始化
      function init() {
        bind()
        render()
      }

      init()
    })()
  </script>
</body>

</html>